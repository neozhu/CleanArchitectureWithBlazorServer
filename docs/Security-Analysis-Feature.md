# 账号安全分析功能

## 概述

账号安全分析功能通过分析用户的登录历史数据，检测潜在的安全威胁并提供相应的安全建议。该功能可以帮助识别账号是否存在泄密风险，并及时提醒用户采取安全措施。

## 功能特性

### 安全威胁检测

系统会检测以下类型的安全威胁：

1. **新IP地址登录** - 检测从未见过的IP地址登录
2. **可疑地理位置** - 检测来自异常地理位置的登录
3. **多次登录失败** - 检测密码暴力破解尝试
4. **异常登录时间** - 检测深夜或凌晨的异常登录
5. **新设备登录** - 检测来自新设备/浏览器的登录
6. **并发会话** - 检测同时从多个地点的登录
7. **快速地理移动** - 检测物理上不可能的快速地理位置变化

### 风险等级

系统定义了四个风险等级：

- **低风险 (Low)** - 无明显安全威胁
- **中等风险 (Medium)** - 存在一些可疑活动，建议关注
- **高风险 (High)** - 检测到明显的安全威胁，建议立即行动
- **严重风险 (Critical)** - 检测到严重的安全威胁，需要紧急处理

## 使用方法

### 1. 查看安全摘要

在用户个人资料页面的"登录历史"标签中，如果检测到安全风险，会显示安全警告提示。

### 2. 详细安全分析

1. 访问用户个人资料页面
2. 点击"安全分析"标签
3. 配置分析参数：
   - 分析周期（1-365天）
   - 是否包含失败登录分析
4. 点击"运行详细安全分析"按钮

### 3. 查看分析结果

分析完成后，系统会显示：

- **安全摘要** - 整体风险等级和关键指标
- **检测到的安全威胁** - 具体的威胁类型和详情
- **安全建议** - 针对检测到的威胁提供的处理建议

## API 使用

### 分析账号安全

```csharp
var query = new AnalyzeAccountSecurityQuery
{
    UserId = "user-id",
    AnalysisPeriodDays = 30,
    IncludeFailedLogins = true
};

var result = await mediator.Send(query);
```

### 获取安全摘要

```csharp
var query = new GetSecuritySummaryQuery
{
    UserId = "user-id"
};

var result = await mediator.Send(query);
```

## 配置参数

### 风险评分规则

- 新IP地址：中等风险 (>3个IP为高风险)
- 登录失败：5次以上为高风险，10次以上为严重风险
- 新设备：2个以上为高风险
- 快速地理移动：4小时内跨地区为高风险

### 缓存策略

- 安全摘要缓存：5分钟
- 详细分析缓存：10分钟
- 缓存标签：loginaudits

## 安全建议

根据检测到的威胁类型，系统会提供以下建议：

1. **立即更改密码** - 当检测到中等及以上风险时
2. **启用双因素认证** - 加强账号安全
3. **检查最近登录活动** - 验证所有活动都是授权的
4. **监控暴力破解攻击** - 考虑临时IP封禁
5. **从所有设备注销** - 仅从可信设备重新登录
6. **联系系统管理员** - 对于严重风险情况

## 扩展功能

### 自定义威胁检测规则

可以通过修改 `AnalyzeAccountSecurityQueryHandler` 中的分析方法来自定义威胁检测规则。

### 集成外部威胁情报

可以集成第三方威胁情报API来增强IP地址和地理位置的风险评估。

### 自动化响应

可以基于风险等级实现自动化响应，如：
- 自动锁定高风险账号
- 发送安全警告邮件
- 触发管理员通知

## 注意事项

1. 该功能需要足够的历史登录数据才能进行有效分析
2. 初次使用时可能会误报一些正常的新设备或IP地址
3. 地理位置检测基于IP地址，可能存在一定误差
4. 建议定期运行安全分析以保持账号安全 